==== Метод: Загрузка фото пользователя

*1. Название метода:*

- *Название метода:*  Загрузка фото

- *URL и Endpoint:* POST https://cats-images.ru/images/upload

*2. Общее описание метода:*

- *Что это:* Метод позволяет пользователям загружать свои фото на сервер. Он проверяет формат и размер загружаемого файла и сохраняет его в объектное хранилище MinIO, а информацию о файле - в базу данных PostgreSQL.

- *Для чего мы это делаем:* Пользователи могут делиться фотографиями, загружая их через мобильное приложение. Это ключевая функциональность приложения CatsPosts.

*Роли пользователей:* Аутентифицированные пользователи.

*3. Алгоритм работы:*

- *Кто делает запрос:* Пользователь отправляет запрос на загрузку фото.

- *Кто обрабатывает:* 

- Сервис аутентификации (CatsAuth Service) валидирует JWT токен 

- Сервис загрузки фото  (CatsImages Service) Обрабатывает загрузку, сохраняет изображение в MinIO, сохраняет метаданные в базе данных

- *К каким таблицам БД обращение:*

 - Таблица images CatsImages Service сохраняет метаданные фото в таблице.

*Шаги:*

1) *Пользователь:* Отправляет POST запрос на /images/upload с авторизационным заголовком и файлом.

2) *API Gateway:* Перенаправляет запрос в CatsImages.

3) *CatsImages* Получает запрос и извлекает JWT токен.

4) *CatsAuth:*

- Проверяет JWT токен.

- Если токен истек, сервер проверяет refresh_token и выдает новый JWT.

5) *CatsImages:* 

- Проверяет формат и размер файла

- Извлекается имя файла, MIME-тип и вычисляется размер в байтах на сервере.

- Если формат не поддерживается (не равен jpg, jpeg, png) или размер превышает 20 МБ, сервер возвращает ошибку.

6) *CatsImages:* Загружает файл в объектное хранилище MinIO и получает URL файла.

7) *CatsImages:* Имя файла, MIME-тип, размер, URL и метка времени сохраняются в таблице images.

8) *CatsImages:* Возвращает ответ с URL файла и метаданными.

*4. Пример запроса:*

- *Метод:* POST

- *URL:* https://cats-images.ru/images/upload

- *query-параметры:* нет

- *Headers:* 

- Content-Type: multipart/form-data
- Authorization: Bearer {token}

*4.2. Тело запроса:*
[source, json]
----
{
  "file": "data:image/png;base64,iVBORw0KGgoAAAANSUhE"
}
----
*5. Пример ответа:*

- *HTTP-201:* Фото успешно загружено.

*Тело ответа:*
[source,json]
----
{
  "imageId": "1",
  "imageUrl": "https://minio.io/images/images.png",
  "uploadedAt": "2024-06-24T12:34:56Z"
}
----

- *HTTP-400:* Неверный формат данных или отсутствие изображения.
*Тело ответа:*
[source,json]
----
{
  "error": "Bad Request",
  "message": "Invalid data format or missing file."
}
----

- *HTTP-401:* Невалидный или просроченный токен.
*Тело ответа:*
[source,json]
----
{
  "error": "Unauthorized",
  "message": "Token is invalid or expired."
}
----


*Таблицы маппинга данных JSON и БД*

*6. Входные параметры POST https://cats-images.ru/images/upload*

|===
|*Название параметра на русском*|*Название параметра в JSON*|*Тип данных в JSON*|*Название параметра в БД*|*Тип данных в БД*|*Описание и алгоритм обработки данных*

|Файл
|file
|string
|images.filename
 images.mime_type
 images.size_bytes
|VARCHAR(255)
 VARCHAR(100)
 bigint
|Загружаемый файл в формате base64. Обрабатывается сервером, сохраняется в MinIO. Данные Content-Disposition    Извлекаются и сохраняются метаданные: filename, mime_type, size_bytes

|Токен авторизации
|Authorization
|string
|user_id (из токена)
|UUID
|Идентификатор пользователя, извлекается из JWT токена. Валидируется сервисом CatsAuth
|===

*6.1 Выходные параметры POST https://cats-images.ru/images/upload*

|===
|*Название параметра на русском*|*Название параметра в JSON*|*Тип данных в JSON*|*Название параметра в БД*|*Тип данных в БД*|*Описание и алгоритм обработки данных*

|Идентификатор фото
|imageId
|string
|images.image_id
|UUID
|Уникальный идентификатор изображения, создается сервером и возвращается в ответе

|URL фото
|imageUrl
|string
|image_url
|varcahr(255)
|URL загруженного фото, возвращается после успешной загрузки

|Время загрузки
|uploadedAt
|string
|images.uploaded_at
|TIMESTAMP
|Время загрузки изображения, генерируется сервером и возвращается в ответе
|===

xref:../../index.adoc[Назад]